name: msys2-portable-action-workflow
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: CLANG64
          update: true

      - name: Clean up MSYS2, keep only clang64
        shell: pwsh
        run: |
          $msys2 = "${{ steps.msys2.outputs.msys2-location }}"
          Write-Host "Cleaning MSYS2 in $msys2"
          Remove-Item "$msys2\mingw32" -Force -Recurse -ErrorAction Ignore
          Remove-Item "$msys2\mingw64" -Force -Recurse -ErrorAction Ignore
          Remove-Item "$msys2\ucrt64" -Force -Recurse -ErrorAction Ignore
          Remove-Item "$msys2\clangarm64" -Force -Recurse -ErrorAction Ignore
          Remove-Item "$msys2\var\cache\pacman\pkg" -Force -Recurse -ErrorAction Ignore
          Remove-Item "$msys2\usr\share\locale" -Force -Recurse -ErrorAction Ignore

      - name: Comment out unneeded repo sections in pacman.conf
        shell: pwsh
        run: |
          $conf = "${{ steps.msys2.outputs.msys2-location }}\etc\pacman.conf"
          $content = Get-Content $conf
          $output = $content | ForEach-Object {
            if ($_ -match '^\[(clangarm64|mingw32|mingw64|ucrt64)\]') {
              "#$_"
            } elseif ($_ -match '^Include = /etc/pacman.d/mirrorlist.mingw') {
              "#$_"
            } else {
              $_
            }
          }
          Set-Content -Path $conf -Value $output

      - name: Remove unused root files and locale directory
        shell: pwsh
        run: |
          $msys2 = "${{ steps.msys2.outputs.msys2-location }}"
          $keep = @("clang64.exe", "clang64.ico", "clang64.ini", "msys2_shell.cmd", "autorebase.bat")
          Get-ChildItem -Path $msys2 -File | Where-Object { $keep -notcontains $_.Name } | Remove-Item -Force

      - name: Archive minimal MSYS2 portable
        uses: thedoctor0/zip-release@master
        with:
          type: 'zip'
          directory: "${{ steps.msys2.outputs.msys2-location }}"
          filename: "msys2-clang64-minimal.zip"

      - name: Release portable msys2
        uses: ncipollo/release-action@v1
        with:
          tag: "main"
          name: "MSYS2 Portable CLANG64 Minimal"
          artifacts: "${{ steps.msys2.outputs.msys2-location }}/msys2-clang64-minimal.zip"
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
